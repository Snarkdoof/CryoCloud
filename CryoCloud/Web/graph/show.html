<!DOCTYPE html>
<html>
<head>
  <title>Show graph</title>
  <style type="text/css">
    body {
      margin: 0;
    }
    #container {
      position: absolute;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <!--<script src="cryonite_ocean.json"></script>-->
  <!--<script src="test2.json"></script>-->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.css" rel="stylesheet" type="text/css" />


  <script>

    var XHR = (function() {
      var api = {};

      api.get = function(url, params, onResult, onError) {
        var xhr = new XMLHttpRequest();
        url += "?";
        for (var i in params) {
          url += i + "=" + params[i] + "&";
        }
        xhr.open("GET", url, true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            onResult(JSON.parse(xhr.response));
          }
          // TODO: if error, call onError
        };
        xhr.send();
      };
      return api;
    })();

    // Default colors:
    // https://color.hailpixel.com/#
    var palette = ["#1C543E", "#D9D68C", "#7E722A", "#732B26", "#BF9F40", "#1C4B54"];
    var palette = ["#2F1849", "#285377", "#507E2A", "#773328", "#C68A53"];
    // var palette = ["#240042", "#900048", "#FF4057", "#ff8260", "black", "black"];

    var colors = {
      entry: "black",
      netwatcher: {background: palette[0], border: palette[1]},
      permanent: {background: palette[0], border: palette[1]},
      remove: {background: palette[3], border: palette[1]},
      unzip: {background: palette[0], border: palette[2]},
      KSAT_report: {background: palette[2], border: palette[0]},
      copy: {background: palette[4], border: palette[1]},
      default: {background: palette[1], border: palette[0]}
    };
    var font = {color: "white"}

    var n_nr = 0;
    var e_nr = 0;

    var nodes = [{id: "entry", label: "Workflow entry", "level": 0, color: colors["entry"], font: font}];
    var edges = [];

    var levels = {entry: 0}

    var parse = function(modules, parent) {
      for (var idx in modules) {
        var m = modules[idx]
        if (parent) {
          if (m.downstreamOf) {
            m.downstreamOf.append(parent);            
          } else {
            m.downstreamOf = [parent];
          }
        }
        // We're at level +1 of our parent
        var level = 0;
        for (var p in m.downstreamOf) {
          level = Math.max(level, levels[m.downstreamOf[p]])
        }
        level++;
        var name = m.name || m.module + n_nr;
        levels[name] = level;
        n_nr++;        
        nodes.push({id: name, label: name + "\n(" + (m.runOn || "always") + ")", level: level, color: colors[m.module] || colors[m.name.toLowerCase()] || colors["default"], font: font});
        // Add edges
        for (var eidx in m.downstreamOf) {
          edges.push({from: m.downstreamOf[eidx], to: name, arrows:'to'})
        }
        if (m.children) {
          parse(m.children, name);
        }
      }
    }

    XHR.get("https://seer2.itek.norut.no/cc/graph/cryonite_ocean2.json", {}, function(wf) {
      console.log("Loading graph", wf);
      // We load the graph here
      parse(wf.workflow.nodes);
      update();
    });

  // create a network
  var container = document.getElementById('container');
  var data = {
    nodes: nodes,
    edges: edges
  };
  var options = {
    nodes: {borderWidth: 2},
    edges: {
        smooth: {
            type: 'cubicBezier',
            forceDirection: 'vertical',
            roundness: 0.4
        }
    },
    layout: {
        hierarchical: {
            direction: "LR"  // "UD" is top down
        }
    },
    physics: false
};

var foptions = {
  nodes: {borderWidth: 2},
  edges: {
    smooth: {
      "forceDirection": "none",
      "roundness": 0.45
    }
  },
  "physics": {
    "barnesHut": {
      "avoidOverlap": 0.5
    },
    "minVelocity": 0.75
  }
}           

  var network = new vis.Network(container, data, options);


  var update  = function() {
        var n = new vis.DataSet(nodes);
        var e = new vis.DataSet(edges);
        network.setData({nodes:n, edges:e})
  }

  </script>
</body>
</html>